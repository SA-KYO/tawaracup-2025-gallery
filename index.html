<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>多和楽杯2025 ギャラリー</title>

  <!-- Tailwind CDN -->
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- フォント -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@500;700&family=Noto+Sans+JP:wght@400;500;700&display=swap" rel="stylesheet">

  <style>
    body {
      font-family: 'Noto Sans JP', system-ui, -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
    }
    .title-font {
      font-family: 'Poppins', 'Noto Sans JP', system-ui, sans-serif;
      letter-spacing: 0.08em;
    }
    #lightbox-backdrop {
      backdrop-filter: blur(8px);
    }
  </style>
</head>
<body class="bg-gradient-to-b from-purple-50 via-pink-50 to-white min-h-screen">

  <div class="max-w-5xl mx-auto px-4 py-6 md:py-10">
    <!-- ヘッダー -->
    <header class="flex items-center justify-between mb-6 md:mb-8">
      <div>
        <h1 class="title-font text-xl md:text-3xl font-bold text-purple-700">
          多和楽杯2025 ギャラリー
        </h1>
        <p class="text-xs md:text-sm text-gray-500 mt-1">
          コンペ当日にみんながアップしてくれた写真・動画が、自動でここに並びます。
        </p>
      </div>

      <a
        href="https://tawaracup-2025-photo.netlify.app/"
        class="hidden sm:inline-flex items-center gap-2 text-xs md:text-sm text-purple-700 border border-purple-300 rounded-full px-3 py-1.5 hover:bg-purple-50 transition"
      >
        ← アップロード画面に戻る
      </a>
    </header>

    <a
      href="https://tawaracup-2025-photo.netlify.app/"
      class="sm:hidden inline-flex mb-4 items-center gap-2 text-xs text-purple-700 border border-purple-300 rounded-full px-3 py-1.5 hover:bg-purple-50 transition"
    >
      ← アップロード画面に戻る
    </a>

    <!-- 保存のコツ（スマホ前提） -->
    <section class="mb-5 md:mb-6">
      <div class="bg-white/80 border border-purple-100 rounded-2xl shadow-sm px-4 py-3 md:px-6 md:py-4 flex flex-col gap-1">
        <div class="flex items-center gap-2 text-purple-700 font-semibold text-sm">
          <span class="inline-flex items-center justify-center w-5 h-5 rounded-full bg-emerald-500 text-white text-[10px]">✓</span>
          <span>写真・動画の保存方法</span>
        </div>
        <p class="text-[11px] md:text-xs text-gray-600 leading-relaxed">
          スマホ：<span class="font-semibold">サムネイルをタップ → 画像・動画が全画面で開いた状態で長押し</span>し、「写真に追加」「ビデオを保存」などを選択してください。<br>
          「⬇︎ 保存」ボタンを押すと、元の画像・動画ページが開きます。そこで長押し → 保存でもOKです。
        </p>
      </div>
    </section>

    <!-- タブ（写真／動画） -->
    <section class="mb-4 md:mb-6">
      <div class="bg-white/60 rounded-full p-1 flex gap-1 shadow-sm">
        <button
          id="tab-images"
          class="flex-1 inline-flex items-center justify-center gap-2 px-3 py-2 md:px-4 md:py-2.5 rounded-full text-xs md:text-sm font-semibold text-purple-700 bg-purple-100 shadow-sm"
          type="button"
        >
          <span>📷</span> 写真
        </button>
        <button
          id="tab-videos"
          class="flex-1 inline-flex items-center justify-center gap-2 px-3 py-2 md:px-4 md:py-2.5 rounded-full text-xs md:text-sm font-semibold text-gray-500 hover:bg-purple-50"
          type="button"
        >
          <span>🎬</span> 動画
        </button>
      </div>
    </section>

    <!-- コンテンツ枠 -->
    <section class="bg-white/80 rounded-3xl shadow-md p-4 md:p-6">
      <!-- セクションタイトル -->
      <div class="flex items-center gap-2 mb-3 md:mb-4">
        <span id="section-icon" class="text-lg">📷</span>
        <h2 id="section-title" class="font-semibold text-purple-700 text-base md:text-lg">
          写真一覧
        </h2>
      </div>

      <!-- ローディング／エラー -->
      <div id="status-area" class="text-center text-xs md:text-sm text-gray-500 py-6 hidden"></div>

      <!-- グリッド -->
      <div
        id="media-grid"
        class="grid grid-cols-2 md:grid-cols-3 gap-3 md:gap-4"
      ></div>
    </section>

    <!-- フッター -->
    <footer class="mt-8 text-center text-[10px] md:text-xs text-gray-400">
      © 2025 多和楽杯コンペ実行委員会
    </footer>
  </div>

  <!-- ライトボックス -->
  <div
    id="lightbox-backdrop"
    class="fixed inset-0 bg-black/70 hidden items-center justify-center z-40"
  >
    <div class="relative max-w-3xl w-full px-3">
      <button
        id="lightbox-close"
        type="button"
        class="absolute -top-10 right-2 text-white/80 hover:text-white text-3xl"
      >
        ×
      </button>
      <div class="bg-black rounded-2xl overflow-hidden shadow-2xl">
        <div class="w-full max-h-[80vh] flex items-center justify-center bg-black">
          <img id="lightbox-image" src="" alt="" class="max-h-[80vh] w-auto object-contain hidden" />
          <video
            id="lightbox-video"
            class="max-h-[80vh] w-auto hidden"
            controls
            playsinline
          ></video>
        </div>
      </div>
    </div>
  </div>

  <script>
    const CLOUD_NAME = 'dpef3dzrk';
    const IMAGE_TAG = 'tawarahai2025';
    const VIDEO_TAG = 'tawarahai2025_video';

    const tabImages = document.getElementById('tab-images');
    const tabVideos = document.getElementById('tab-videos');
    const mediaGrid = document.getElementById('media-grid');
    const statusArea = document.getElementById('status-area');
    const sectionIcon = document.getElementById('section-icon');
    const sectionTitle = document.getElementById('section-title');

    const lightboxBackdrop = document.getElementById('lightbox-backdrop');
    const lightboxClose = document.getElementById('lightbox-close');
    const lightboxImage = document.getElementById('lightbox-image');
    const lightboxVideo = document.getElementById('lightbox-video');

    let currentType = 'image'; // 'image' or 'video'

    // Cloudinary リスト API
    async function fetchMediaList(type) {
      const tag = type === 'image' ? IMAGE_TAG : VIDEO_TAG;
      const kind = type === 'image' ? 'image' : 'video';
      const url = `https://res.cloudinary.com/${CLOUD_NAME}/${kind}/list/${tag}.json`;

      const res = await fetch(url, { cache: 'no-store' });
      if (!res.ok) {
        throw new Error('Cloudinary list API error');
      }
      const data = await res.json();
      return (data.resources || []).sort((a, b) => (b.created_at > a.created_at ? 1 : -1));
    }

    function showStatus(message, isError = false) {
      if (!message) {
        statusArea.classList.add('hidden');
        statusArea.textContent = '';
        return;
      }
      statusArea.textContent = message;
      statusArea.classList.remove('hidden');
      statusArea.classList.toggle('text-red-500', isError);
    }

    function openLightbox(url, type) {
      if (type === 'image') {
        lightboxVideo.classList.add('hidden');
        lightboxVideo.pause();
        lightboxImage.src = url;
        lightboxImage.classList.remove('hidden');
      } else {
        lightboxImage.classList.add('hidden');
        lightboxImage.src = '';
        lightboxVideo.src = url;
        lightboxVideo.classList.remove('hidden');
        lightboxVideo.play().catch(() => {});
      }
      lightboxBackdrop.classList.remove('hidden');
      lightboxBackdrop.classList.add('flex');
    }

    function closeLightbox() {
      lightboxBackdrop.classList.add('hidden');
      lightboxBackdrop.classList.remove('flex');
      lightboxImage.src = '';
      lightboxVideo.pause();
      lightboxVideo.src = '';
    }

    lightboxBackdrop.addEventListener('click', (e) => {
      if (e.target === lightboxBackdrop) closeLightbox();
    });
    lightboxClose.addEventListener('click', closeLightbox);

    function renderMedia(type, items) {
      mediaGrid.innerHTML = '';

      if (!items.length) {
        showStatus('まだアップロードされた' + (type === 'image' ? '写真' : '動画') + 'がありません。', false);
        return;
      }
      showStatus('');

      items.forEach((item) => {
        const isImage = type === 'image';
        const baseKind = isImage ? 'image' : 'video';

        // フル表示用 URL（＝スマホで長押し保存に使うURL）
        const originalUrl =
          `https://res.cloudinary.com/${CLOUD_NAME}/${baseKind}/upload/${item.public_id}.${item.format}`;

        // サムネイル用 URL
        let thumbUrl;
        if (isImage) {
          thumbUrl =
            `https://res.cloudinary.com/${CLOUD_NAME}/image/upload/c_fill,w_800,h_1000,q_auto,f_auto/${item.public_id}.${item.format}`;
        } else {
          thumbUrl =
            `https://res.cloudinary.com/${CLOUD_NAME}/video/upload/so_3,c_fill,w_800,h_1000,q_auto,f_auto/${item.public_id}.jpg`;
        }

        const card = document.createElement('div');
        card.className =
          'relative bg-white rounded-2xl shadow-md overflow-hidden ring-1 ring-purple-50';

        // カードタップ → ライトボックスで拡大表示
        card.addEventListener('click', () => {
          openLightbox(originalUrl, type);
        });

        card.innerHTML = `
          <img
            src="${thumbUrl}"
            alt=""
            loading="lazy"
            class="w-full aspect-[3/4] object-cover"
          />
          <button
            type="button"
            class="absolute bottom-2 right-2 inline-flex items-center gap-1 px-3 py-1.5 rounded-full text-[11px] font-semibold bg-white/90 text-purple-700 shadow-md hover:bg-white"
          >
            <span class="text-base leading-none">⬇︎</span>
            <span>保存</span>
          </button>
        `;

        const saveButton = card.querySelector('button');
        saveButton.addEventListener('click', (e) => {
          e.stopPropagation(); // ライトボックス表示はさせない
          // ★ PCダウンロード用の特殊URLは使わず、元ファイルのページを開くだけ
          window.open(originalUrl, '_blank');
        });

        mediaGrid.appendChild(card);
      });
    }

    async function loadMedia(type) {
      currentType = type;

      // タブ見た目
      if (type === 'image') {
        tabImages.className =
          'flex-1 inline-flex items-center justify-center gap-2 px-3 py-2 md:px-4 md:py-2.5 rounded-full text-xs md:text-sm font-semibold text-purple-700 bg-purple-100 shadow-sm';
        tabVideos.className =
          'flex-1 inline-flex items-center justify-center gap-2 px-3 py-2 md:px-4 md:py-2.5 rounded-full text-xs md:text-sm font-semibold text-gray-500 hover:bg-purple-50';
        sectionIcon.textContent = '📷';
        sectionTitle.textContent = '写真一覧';
      } else {
        tabVideos.className =
          'flex-1 inline-flex items-center justify-center gap-2 px-3 py-2 md:px-4 md:py-2.5 rounded-full text-xs md:text-sm font-semibold text-purple-700 bg-purple-100 shadow-sm';
        tabImages.className =
          'flex-1 inline-flex items-center justify-center gap-2 px-3 py-2 md:px-4 md:py-2.5 rounded-full text-xs md:text-sm font-semibold text-gray-500 hover:bg-purple-50';
        sectionIcon.textContent = '🎬';
        sectionTitle.textContent = '動画一覧';
      }

      showStatus('読み込み中です…', false);
      mediaGrid.innerHTML = '';

      try {
        const list = await fetchMediaList(type);
        renderMedia(type, list);
      } catch (err) {
        console.error(err);
        showStatus('読み込みに失敗しました。時間をおいて再度お試しください。', true);
      }
    }

    tabImages.addEventListener('click', () => loadMedia('image'));
    tabVideos.addEventListener('click', () => loadMedia('video'));

    // 初期表示：写真タブ
    loadMedia('image');
  </script>
</body>
</html>
